---
catalog:		true
header-style:	text
subtitle:		实践是检验真理的唯一标准
tags:
- 杂感
- http
- 前端

---



## 背景

​	最近的用户频繁反馈线上出现问题。经过我的分析，用户所遇到的问题，都是在新版本发布之后，旧版本的前端页面才会出现的问题。

## 流程图



### 部署

```

+----------+
|    vue   | code
+----------+
      |
      |      action
     \|/
+----------+
|   flow   | 
+----------+
      |     
      |    build
      |
      |    upload
     \|/
+----------+
|   oss    | 
+----------+

```

### 访问

```

+------------+
|   browser  ｜
+------------+
       |
       |   Network
      \|/
+------------+
|     CDN    ｜
+------------+
       |
       |
      \|/
+------------+ 
|     OSS    ｜
+------------+

```



## 分析

​	首先 vue 的打包，每次 vue 打包出来的 html 文件名不变，js，css 文件名是每次都不一样，打包的时候，html 引用的 js，css 也会自动的帮我们处理好。

| 文件              | 缓存策略                             |
| ----------------- | ------------------------------------ |
| Html              | 不缓存                               |
| js<br>css<br/>img | 缓存 1年。（其实理论是可以永久的。） |

​	流水线我们使用的是 阿里云，云效产品下的一个子产品，flow 流水线来构建我们的流水线体系。

----

​	在 2022-03-28 日的时候，我构建了一个前端流水线。

​	当时我看了看阿里云相关文档，

> - OSS：“设置文件HTTP头来自定义HTTP请求的策略” 。
> - CDN：
    >   1. 源站响应`pragma:no-cache`、`cache-control:no-cache`（或者`no-store`，或者`max-age=0`）时，不缓存。
>   2. CDN控制台设置的缓存过期时间或者状态码过期时间
>   3. CDN控制台设置的缓存过期时间或者状态码过期时间
>   4. 源站返回的数据中`ETag`、`last-modified`、`cache-control`和`expires`这些缓存相关的响应头都没有携带，则默认不缓存。

---

​	我司在 2022-10 的之前前端缓存导致的问题有很多。哎，**一言难进**。

----

​	在 2022-10 月份的时候，前端的流水线，我全部整理了一遍，全部都在流水线中给 html 文件中添加了HTTP头：`Cache-Control:no-cache`。



### 这个问题就认为已经解决了

​	那么现在为什么又有问题了呢？



### 看了下 oss

oss 的 html 都是带着 `Cache-Control:no-cache` 这个请求头的。

那么 oss、CDN 的问题应该不大。

猜想是有可能是 flow 流水线有问题。

排查了一下日志终于在 flow 上传到 oss 的日志中，我排查到了问题

```shell
....
....
[00:54:12] ossutil cp -r /root/workspace/${project_name}_z2XJ/dist/ oss://${oss-bucket}/${filename}/ --update
...
...
[00:54:16] 发现meta规则设置，对指定文件进行重新上传
[00:54:16] 重新上传 html 结尾的文件，并添加 Cache-Control:no-cache 的 meta 信息
[00:54:16] 拷贝 html 结尾的文件至 /tmp/html
[00:54:16] 上传 /tmp/html/dist/ 中的文件至oss
[00:54:16] ossutil cp -r -f --meta Cache-Control:no-cache /tmp/html/dist/ oss://${oss-bucket}/${filename}/

```

### 定位

终于定位到了问题，

发现了没？

一共上传了两次文件

1. 上传 html、css、js  ；（这次没有加 `Cache-Control:no-cache`）
2. 第二次上传 html ；（ 添加   `Cache-Control:no-cache`  ）



## 反馈问题

找到阿里云的 flow 的人



> 我描述了一下问题。
>
>
>
> 他说：这个设计就是这样的，这个问题不会影响到客户说的”缓存“问题。客户说的”有缓存“是哪里有缓存呢？流水线不会缓存上传的OSS文件的。“上传两次和no-cache是否生效没有关系的，这里只是上传到OSS, 至于no-cache是否生效，这个我们不负责的”
>
> >  我说：我是觉得你应该读一下我的问题。或者说，你应该仔细的理解一下，你讲的是你们产品就是这么设计的。 **我讲的是，这个设计是有漏洞的。 你需要告诉我，怎么避免这个漏洞，而不是这个产品就是这么设计的。**
>
> 他说：那么这两个间隙访问到的 html 相当于是不是就缓存下来了。-------麻烦在oss上传还没有上传结束的时候不要获取这个html呢
>
> > 我说：淘宝的 html 在某段时间是不能打开的吗？
>
> 他说：这个我去和产研反馈一下，您稍等。
>
> 他说：这个问题讨论了一下，我们会优化这个问题
>
> 他说：这个排期的话大约在2月30号以后了，具体的时间我们不能给出的。
>
> > 我说：这个问题，有其他办法可以规避吗？
>
> 他说：这个我去咨询了一下，暂时没有什么好的规避方法？



说实在的，我无法理解，解释一通，还是没有理解我的问题，当我重复的讲述：“**你们的设计是存在漏洞的**” 的时候，他们才会去思考是否是真的有漏洞。而且我也不认为这个是设计上的问题！这个明明是开发实践的问题。

当然，我不觉得我的表述又问题，因为，我重复讲述“**你们的设计是存在漏洞的**”  的时候，他立马就反馈知道了，的确是有问题的。

客户第一，还是没有做好啊。。。

引申想一下：老板是不是我们打工人的客户？



## 换种方式解决

关于这个问题，我又咨询了一下我前端的朋友。

通过在 html 页面中添加头，解决这个问题。

```html
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
```

**这个问题，到底解决了没有，还需要谨慎观察。**


> 不过我可以用写一个 接口，刷新 CDN 的接口，在流水线中配置，curl 命令自动执行来实现这个问题
> 记录一个 TODO list。 :smile:



## 关于 DevOps

​	关于我们现在比较流行的 DevOps 一体化，指的不是，`运维的活就开发干` 或者 `开发的活运维干` 。它更像是一种意识形态，大家全部向前一步的意识形态。



## 感想

- 广度是深度的副产品。--左耳朵耗子
- 实践是检验真理的唯一标准。
- 一定要坚持客户第一。
- DevOps 是一种意识形态。
